name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Extract version from tag
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $version = $matches[1]
        } else {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
    
    - name: Build Single-File Executable
      shell: pwsh
      run: |
        Write-Host "Building single-file executable..." -ForegroundColor Green
        dotnet clean -c Release
        dotnet restore
        dotnet publish -c Release -r win-x64 `
          --self-contained true `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:EnableCompressionInSingleFile=true `
          /p:DebugType=none `
          /p:DebugSymbols=false
        
        $exePath = "bin\Release\net8.0\win-x64\publish\FastDLX.exe"
        if (Test-Path $exePath) {
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "Single-file size: $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
        }
    
    - name: Create Release Archives
      shell: pwsh
      run: |
        Write-Host "Creating release artifacts..." -ForegroundColor Yellow
        
        # Create release directory
        New-Item -ItemType Directory -Path ".\release" -Force | Out-Null
        
        # Verify portable exe exists
        $exePath = "bin\Release\net8.0\win-x64\publish\FastDLX.exe"
        if (-not (Test-Path $exePath)) {
          Write-Host "ERROR: Portable EXE not found at $exePath" -ForegroundColor Red
          exit 1
        }
        
        # Create portable version zip
        Write-Host "Creating portable ZIP..." -ForegroundColor Cyan
        Compress-Archive -Path $exePath `
          -DestinationPath ".\release\FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip" `
          -Force
        
        # Verify and copy MSI to release folder
        $msiSource = ".\installer\FastDLX-${{ steps.get_version.outputs.VERSION }}.msi"
        $msiDest = ".\release\FastDLX-v${{ steps.get_version.outputs.VERSION }}-installer.msi"
        
        if (-not (Test-Path $msiSource)) {
          Write-Host "ERROR: MSI not found at $msiSource" -ForegroundColor Red
          Write-Host "Installer directory contents:" -ForegroundColor Yellow
          Get-ChildItem ".\installer" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $_" }
          exit 1
        }
        
        Write-Host "Copying MSI installer..." -ForegroundColor Cyan
        Copy-Item $msiSource $msiDest
        
        # Verify and copy certificate
        $certSource = ".\installer\FastDLX.pfx"
        if (-not (Test-Path $certSource)) {
          Write-Host "ERROR: Certificate not found at $certSource" -ForegroundColor Red
          exit 1
        }
        
        Write-Ho" -Encoding UTF8
        
        Write-Host "Release artifacts created:" -ForegroundColor Green
        Get-ChildItem ".\release" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Host "  $($_.Name) - $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
        }
    Portable Version
        1. Download FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip
        2. Extract FastDLX.exe to any folder
        3. Run FastDLX.exe
        
        ## What's New
        See the release notes below for changes in this version
            $size = (Get-Item $file).Length / 1MB
            Write-Host "✓ $file ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
          } else {
            Write-Host "✗ $file (NOT FOUND)" -ForegroundColor Red
            $allExist = $false
          }
        }
        
        if (-not $allExist) {
          Write-Host "Some artifacts are missing!" -ForegroundColor Red
          exit 1
        }
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip
          release/FastDLX-v${{ steps.get_version.outputs.VERSION }}-installer.msi
          release/FastDLX-Certificate.pfx
          release/INSTALL.txt
        body: |
          ## FastDLX v${{ steps.get_version.outputs.VERSION }}
          
          Fast downoad Options
          - **Portable**: `FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip` - Extract and run, no installation needed
          - **Installer**: `FastDLX-v${{ steps.get_version.outputs.VERSION }}-installer.msi` - Windows installer with Start Menu shortcut
          
          ### Installation
          See `INSTALL.txt` for detailed instructions.
          
          **Note**: The MSI installer is signed with a self-signed certificate. You'll need to install `FastDLX-Certificate.pfx` (password: `FastDLX2025`) before running the installer.
          
          ### Features
          - Resume interrupted downloads
          - Automatic directory detection for Counter-Strike: Source
          - Server presets and custom server support
          - Optional map file downloads
          - Progress tracking and logging
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
INSTALL.txt
        body: |
          ## FastDLX v${{ steps.get_version.outputs.VERSION }}
          
          Fast download manager for game servers with FastDL support.
          
          ### Download
          - **Portable**: `FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip` - Extract and run, no installation needed
          
          ### Installation
          See `INSTALL.txt` for instructions