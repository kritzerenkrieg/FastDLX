name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Extract version from tag
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $version = $matches[1]
        } else {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
    
    - name: Build Single-File Executable
      shell: pwsh
      run: |
        Write-Host "Building single-file executable..." -ForegroundColor Green
        dotnet clean -c Release
        dotnet restore
        dotnet publish -c Release -r win-x64 `
          --self-contained true `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:EnableCompressionInSingleFile=true `
          /p:DebugType=none `
          /p:DebugSymbols=false
        
        $exePath = "bin\Release\net8.0\win-x64\publish\FastDLX.exe"
        if (Test-Path $exePath) {
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "Single-file size: $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
        }
    
    - name: Create Release Archives
      shell: pwsh
      run: |
        Write-Host "Creating release artifacts..." -ForegroundColor Yellow
        
        # Create release directory
        New-Item -ItemType Directory -Path ".\release" -Force | Out-Null
        
        # Verify portable exe exists
        $exePath = "bin\Release\net8.0\win-x64\publish\FastDLX.exe"
        if (-not (Test-Path $exePath)) {
          Write-Host "ERROR: Portable EXE not found at $exePath" -ForegroundColor Red
          exit 1
        }
        
        # Create portable version zip
        Write-Host "Creating portable ZIP..." -ForegroundColor Cyan
        Compress-Archive -Path $exePath `
          -DestinationPath ".\release\FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip" `
          -Force
        
        Write-Host "Release artifacts created:" -ForegroundColor Green
        Get-ChildItem ".\release" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Host "  $($_.Name) - $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
        }
    
    - name: Verify release files
      shell: pwsh
      run: |
        Write-Host "Verifying release files..." -ForegroundColor Yellow
        $expectedFile = ".\release\FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip"
        
        if (Test-Path $expectedFile) {
          $size = (Get-Item $expectedFile).Length / 1MB
          Write-Host "✓ $expectedFile ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
        } else {
          Write-Host "✗ $expectedFile (NOT FOUND)" -ForegroundColor Red
          Write-Host "Release directory contents:" -ForegroundColor Yellow
          Get-ChildItem ".\release" -ErrorAction SilentlyContinue
          exit 1
        }
    
    - name: Upload artifacts for debugging
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: release/*
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
        body: |
          ## FastDLX v${{ steps.get_version.outputs.VERSION }}
          
          Fast download manager for game servers with FastDL support.
          
          ### Download
          - **Portable**: `FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip` - Extract and run, no installation needed
          
          ### Installation
          1. Download the portable ZIP file
          2. Extract FastDLX.exe to any folder
          3. Run FastDLX.exe
          
          ### Features
          - Resume interrupted downloads
          - Automatic directory detection for Counter-Strike: Source
          - Server presets and custom server support
          - Optional map file downloads
          - Progress tracking and logging
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release Archives
      shell: pwsh
      run: |
        Write-Host "Creating release artifacts..." -ForegroundColor Yellow
        
        # Create release directory
        New-Item -ItemType Directory -Path ".\release" -Force | Out-Null
        
        # Verify portable exe exists
        $exePath = "bin\Release\net8.0\win-x64\publish\FastDLX.exe"
        if (-not (Test-Path $exePath)) {
          Write-Host "ERROR: Portable EXE not found at $exePath" -ForegroundColor Red
          Write-Host "Searching for exe files..." -ForegroundColor Yellow
          Get-ChildItem -Path "bin" -Filter "*.exe" -Recurse | ForEach-Object {
            Write-Host "Found: $($_.FullName)" -ForegroundColor Cyan
          }
          exit 1
        }
        
        # Copy exe to release folder first
        Copy-Item -Path $exePath -Destination ".\release\FastDLX.exe" -Force
        
        # Create portable version zip
        Write-Host "Creating portable ZIP..." -ForegroundColor Cyan
        Compress-Archive -Path ".\release\FastDLX.exe" `
          -DestinationPath ".\release\FastDLX-v${{ steps.get_version.outputs.VERSION }}-portable.zip" `
          -Force
        
        # Remove the copied exe (keep only zip)
        Remove-Item ".\release\FastDLX.exe" -Force
        
        Write-Host "Release artifacts created:" -ForegroundColor Green
        Get-ChildItem ".\release" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Host "  $($_.Name) - $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
        }